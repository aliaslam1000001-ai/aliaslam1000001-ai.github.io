<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Chat + Avatars</title>
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg-color: #f0f2f5; --chat-bg: #ffffff; --text-color: #1a1a1a;
            --secondary-text: #65676b; --input-bg: #f0f2f5; --msg-bg: #f0f2f5;
            --msg-text: #050505; --header-border: #e5e5e5; --accent-color: #764ba2;
            --emoji-bg: #ffffff; --emoji-border: #ddd;
            --alert-bg: #ffdddd; /* New style for alerts */
        }
        [data-theme="dark"] {
            --bg-color: #18191a; --chat-bg: #242526; --text-color: #e4e6eb;
            --secondary-text: #b0b3b8; --input-bg: #3a3b3c; --msg-bg: #3a3b3c;
            --msg-text: #e4e6eb; --header-border: #3e4042; --accent-color: #a270d6;
            --emoji-bg: #2d2d2d; --emoji-border: #444;
            --alert-bg: #764ba2; /* New style for alerts */
        }

        html, body { height: 100%; margin: 0; overflow: hidden; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color); 
            height: 100dvh; 
        }

        /* LOGIN SCREEN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; width: 85%; max-width: 340px; }
        .login-input, .room-select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; text-align: center; outline: none; }
        .login-btn { background: #764ba2; color: white; border: none; padding: 12px 30px; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 15px; }
        
        /* AVATAR SELECTION */
        .avatar-label { font-size: 14px; color: #666; margin-top: 10px; display: block; }
        .avatar-options { display: flex; justify-content: center; gap: 15px; margin: 10px 0; }
        .avatar-option { width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: 0.2s; background: #f0f0f0; }
        .avatar-option:hover { transform: scale(1.1); }
        .avatar-option.selected { border-color: var(--accent-color); background: #e0d4fc; }

        /* CHAT UI */
        .chat-container { 
            background: var(--chat-bg); width: 100%; max-width: 600px; 
            height: 100%; margin: 0 auto; display: flex; flex-direction: column; display: none; 
            box-shadow: 0 0 20px rgba(0,0,0,0.1); position: relative;
        }
        
        header { background-color: var(--chat-bg); padding: 10px 15px; border-bottom: 1px solid var(--header-border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        h2 { margin: 0; font-size: 16px; color: var(--text-color); }
        .room-badge { background: var(--accent-color); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 5px;}
        .header-controls button, .about-btn { background: transparent; border: 1px solid var(--secondary-text); color: var(--text-color); padding: 4px 8px; border-radius: 15px; cursor: pointer; margin-left: 5px; font-size: 12px; }
        .about-btn { text-decoration: none; display: inline-block; }

        /* Pinned Message Style */
        #pinned-message { background: var(--alert-bg); color: var(--text-color); padding: 8px 15px; font-size: 13px; text-align: center; border-bottom: 1px solid var(--header-border); display: none; }

        #messages { flex: 1; padding: 15px; overflow-y: scroll; background-color: var(--chat-bg); display: flex; flex-direction: column; gap: 15px; -webkit-overflow-scrolling: touch; }
        .msg { display: flex; align-items: flex-start; animation: fadeIn 0.3s ease; cursor: pointer; }
        
        /* NEW AVATAR STYLE */
        .msg-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; background: #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .msg-content { max-width: 80%; }
        .msg-info { font-size: 11px; color: var(--secondary-text); margin-bottom: 2px; margin-left: 2px; }
        .msg-text { background: var(--msg-bg); color: var(--msg-text); padding: 8px 12px; border-radius: 15px; font-size: 14px; line-height: 1.4; word-wrap: break-word; }
        .msg-text a { color: var(--accent-color); }
        .msg-text b { color: var(--accent-color); }
        .msg-text code { background: rgba(0,0,0,0.1); padding: 2px 5px; border-radius: 4px; font-family: monospace; color: #d63384; }
        .msg-image { max-width: 100%; border-radius: 12px; margin-top: 5px; }

        #typing-bar { padding: 2px 15px; font-size: 12px; color: var(--accent-color); font-style: italic; min-height: 18px; background: var(--chat-bg); opacity: 0; transition: opacity 0.3s; }
        #maintenance-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); color: white; display: none; justify-content: center; align-items: center; flex-direction: column; text-align: center; z-index: 1001; }
        .input-area { 
            padding: 10px; background: var(--chat-bg); border-top: 1px solid var(--header-border); 
            display: flex; gap: 8px; align-items: center; padding-bottom: env(safe-area-inset-bottom); flex-shrink: 0; position: relative;
        }
        #messageInput { flex: 1; padding: 10px; background: var(--input-bg); color: var(--text-color); border-radius: 20px; border: none; outline: none; font-size: 16px; }
        #sendBtn { background: var(--accent-color); color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 16px;}

        /* EMOJI PICKER */
        #emojiBtn { cursor: pointer; font-size: 22px; background: none; border: none; padding: 0 5px; filter: grayscale(100%); transition: 0.2s; }
        #emojiBtn:hover { filter: grayscale(0%); transform: scale(1.1); }
        
        #emojiPicker {
            position: absolute; bottom: 70px; left: 10px; width: 250px; height: 200px;
            background: var(--emoji-bg); border: 1px solid var(--emoji-border); border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: none; grid-template-columns: repeat(6, 1fr);
            gap: 5px; padding: 10px; overflow-y: auto; z-index: 100;
        }
        .emoji-item { font-size: 20px; cursor: pointer; text-align: center; padding: 5px; border-radius: 5px; }
        .emoji-item:hover { background: rgba(0,0,0,0.1); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="maintenance-overlay">
        <h1>üõ†Ô∏è System Maintenance üõ†Ô∏è</h1>
        <p>The chat room is currently closed for maintenance and updates by the Administrator.</p>
        <p style="font-size: 1.2em; margin-top: 20px;">Please check back later!</p>
    </div>

    <div id="login-screen">
        <div class="login-card">
            <h2>Join Chat</h2>
            <input type="text" id="loginNameInput" class="login-input" placeholder="Your Name" autocomplete="off">
            <input type="password" id="loginPassInput" class="login-input" placeholder="Password (12345)">
            
            <span class="avatar-label">Choose your look:</span>
            <div class="avatar-options">
                <img src="https://api.dicebear.com/9.x/adventurer/svg?seed=1" class="avatar-option selected" onclick="selectStyle('adventurer', this)">
                <img src="https://api.dicebear.com/9.x/bottts/svg?seed=2" class="avatar-option" onclick="selectStyle('bottts', this)">
                <img src="https://api.dicebear.com/9.x/thumbs/svg?seed=3" class="avatar-option" onclick="selectStyle('thumbs', this)">
            </div>

            <select id="roomSelect" class="room-select">
                <option value="general">üè† General Chat</option>
                <option value="tech">üíª Tech Talk</option>
                <option value="it">üîå IT Support</option>
                <option value="gaming">üéÆ Gaming</option>
            </select>
            <button class="login-btn" onclick="attemptLogin()">Join Room</button>
        </div>
    </div>

    <div class="chat-container" id="chatInterface">
        <header>
            <div style="display: flex; flex-direction: column;">
                <h2 id="headerTitle">Chat</h2>
                <span id="currentRoomBadge" class="room-badge">General</span>
            </div>
            <div class="header-controls">
                <a href="about.html" style="text-decoration:none;"><button class="about-btn">‚ÑπÔ∏è</button></a>
                <button onclick="toggleTheme()" id="themeBtn">üåô</button>
                <button onclick="clearChat()" style="color:#dc3545; border-color:#dc3545">üóëÔ∏è</button>
            </div>
        </header>

        <div id="pinned-message"></div>

        <div id="messages"></div>
        <div id="typing-bar">Someone is typing...</div>

        <div class="input-area">
            <div id="emojiPicker"></div>
            <input type="file" id="fileInput" accept="image/*" style="display:none">
            <label for="fileInput" style="cursor:pointer; font-size:22px; color: #65676b">üìé</label>
            <button id="emojiBtn" onclick="toggleEmojiPicker()">üòÄ</button>
            <input type="text" id="messageInput" placeholder="Message...">
            <button id="sendBtn" onclick="sendMessage()">‚û§</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, set, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

        // ----------------------------------------------------
        // üîë CRITICAL: ENSURE THESE CREDENTIALS ARE CORRECT
        // ----------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyDyOcdbasPRMo8FHxOyLw0WnmhkwOSGF8o",
            authDomain: "mypersonalchatboxapp.firebaseapp.com",
            databaseURL: "https://mypersonalchatboxapp-default-rtdb.firebaseio.com",
            projectId: "mypersonalchatboxapp",
            storageBucket: "mypersonalchatboxapp.firebasestorage.app",
            messagingSenderId: "290120332790",
            appId: "1:290120332790:web:14e0487f7d37b5e404c3d7",
            measurementId: "G-0695T29ZT6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const sound = new Audio("https://www.soundjay.com/buttons/sounds/button-16.mp3");
        const ROOM_PASSWORD = "12345"; 
        
        let activeChatRef, typingRef; 
        let currentUser = "";
        let currentRoomName = "";
        let currentAvatarStyle = "adventurer";
        let typingTimeout;
        let blockedWords = []; 
        
        const loginNameInput = document.getElementById("loginNameInput");
        const loginPassInput = document.getElementById("loginPassInput");
        const roomSelect = document.getElementById("roomSelect");
        const chatInterface = document.getElementById("chatInterface");
        const loginScreen = document.getElementById("login-screen");
        const maintenanceOverlay = document.getElementById("maintenance-overlay");
        const messageInput = document.getElementById("messageInput");

        // Auto-fill name
        const savedName = localStorage.getItem("chatUsername");
        if(savedName) loginNameInput.value = savedName;

        // --- AVATAR SELECTION LOGIC ---
        window.selectStyle = function(style, element) {
            currentAvatarStyle = style;
            document.querySelectorAll('.avatar-option').forEach(img => img.classList.remove('selected'));
            element.classList.add('selected');
        }

        // --- ATTEMPT LOGIN (NEW: Enforces Ban and Maintenance Mode) ---
        window.attemptLogin = function() {
            const name = loginNameInput.value.trim();
            const pass = loginPassInput.value.trim();
            const room = roomSelect.value;

            if(!name) return alert("Name required!");
            if(pass !== ROOM_PASSWORD) return alert("Wrong Password!");

            // Reference to user data and global settings
            const userRef = ref(db, 'users/' + name);
            const settingsRef = ref(db, 'settings');

            // 1. Check Maintenance Mode first (read global setting)
            // Use onValue with { onlyOnce: true } to check the current state immediately
            onValue(ref(settingsRef, 'maintenance_mode'), (maintenanceSnapshot) => {
                if (maintenanceSnapshot.val() === true) {
                    loginScreen.style.display = "none";
                    maintenanceOverlay.style.display = "flex";
                    return; 
                }
                
                // 2. Check Ban Status (read user-specific setting)
                onValue(ref(userRef, 'banned'), (banSnapshot) => {
                    if (banSnapshot.val() === true) {
                        alert("‚ùå Your account has been banned by the Administrator.");
                        return; 
                    }
                    
                    // 3. If clear, proceed to chat session
                    startChatSession(name, room);
                }, { onlyOnce: true });
            }, { onlyOnce: true });
        }

        // --- START CHAT SESSION ---
        function startChatSession(name, room) {
            currentUser = name;
            localStorage.setItem("chatUsername", name);
            currentRoomName = room;

            document.getElementById("headerTitle").innerText = name;
            document.getElementById("currentRoomBadge").innerText = room.toUpperCase();
            loginScreen.style.display = "none";
            chatInterface.style.display = "flex";

            activeChatRef = ref(db, 'rooms/' + room + '/messages');
            typingRef = ref(db, 'rooms/' + room + '/typing');

            const myTypingRef = ref(db, 'rooms/' + room + '/typing/' + name);
            onDisconnect(myTypingRef).remove();

            loadMessages();
            setupTypingListener();
            setupAdminListeners(); // Start listening for admin commands
        }
        
        // --- LOAD MESSAGES ---
        function loadMessages() {
            onValue(activeChatRef, (snapshot) => {
                const msgBox = document.getElementById("messages");
                msgBox.innerHTML = ""; 
                const data = snapshot.val();
                if(data) {
                    Object.entries(data).forEach(([key, chat]) => {
                        let contentHtml = chat.type === 'image' 
                            ? `<img src="${chat.message}" class="msg-image">` 
                            : formatMessage(chat.message || "");
                        
                        let avatarSrc = chat.avatarUrl || `https://api.dicebear.com/9.x/initials/svg?seed=${chat.name}`;

                        const newMsg = document.createElement('div');
                        newMsg.className = 'msg';
                        newMsg.ondblclick = () => deleteMessage(key); 
                        
                        newMsg.innerHTML = `
                            <img src="${avatarSrc}" class="msg-avatar">
                            <div class="msg-content">
                                <div class="msg-info"><strong>${chat.name}</strong> ‚Ä¢ ${chat.time}</div>
                                <div class="msg-text">${contentHtml}</div>
                            </div>
                        `;
                        msgBox.appendChild(newMsg);
                    });
                    sound.play().catch(e=>{});
                    msgBox.scrollTop = msgBox.scrollHeight;
                }
            });
        }

        // --- ADMIN LISTENERS (Reads commands from Admin Panel) ---
        function setupAdminListeners() {
            const settingsRef = ref(db, 'settings');

            // A. Listen for Pinned Message updates
            onValue(ref(settingsRef, 'pinned_message'), (snapshot) => {
                const pinnedMsg = snapshot.val();
                const pinnedDiv = document.getElementById('pinned-message');
                if (pinnedMsg && pinnedMsg.trim() !== '') {
                    pinnedDiv.innerText = `üìå ${pinnedMsg}`;
                    pinnedDiv.style.display = 'block';
                } else {
                    pinnedDiv.style.display = 'none';
                }
            });

            // B. Listen for System Alerts
            onValue(ref(db, 'alerts'), (snapshot) => {
                const alerts = snapshot.val();
                if (alerts) {
                    // Find the most recent alert
                    const alertKeys = Object.keys(alerts);
                    const lastAlertKey = alertKeys[alertKeys.length - 1];
                    const lastAlert = alerts[lastAlertKey];
                    
                    // Check if the user has already seen this specific alert (using sessionStorage)
                    if (!sessionStorage.getItem('lastAlertTimestamp') || sessionStorage.getItem('lastAlertTimestamp') < lastAlert.timestamp) {
                        alert(`üö® NEW SYSTEM ALERT: ${lastAlert.message}`);
                        sessionStorage.setItem('lastAlertTimestamp', lastAlert.timestamp);
                    }
                }
            });

            // C. Listen for Blocked Words
            onValue(ref(settingsRef, 'blocked_words'), (snapshot) => {
                const wordsObject = snapshot.val();
                blockedWords = Object.keys(wordsObject || {});
                console.log("Blocked words updated:", blockedWords);
            });

            // D. Listen for Maintenance Mode changes (in case admin toggles it while user is logged in)
            onValue(ref(settingsRef, 'maintenance_mode'), (snapshot) => {
                if (snapshot.val() === true) {
                    alert("The Administrator has initiated Maintenance Mode. You will be logged out.");
                    window.location.reload(); 
                }
            });
        }

        // --- SEND MESSAGE (NEW: Enforces Word Block) ---
        window.sendMessage = function() {
            const text = messageInput.value;

            // 1. Check for blocked words before sending
            const lowerText = text.toLowerCase();
            const foundBlockedWord = blockedWords.find(word => lowerText.includes(word));

            if (foundBlockedWord) {
                alert(`üö´ Message blocked! The word "${foundBlockedWord}" is not allowed.`);
                messageInput.value = "";
                return;
            }
            
            // 2. Proceed if not blocked
            if(text.trim() !== "") {
                const myAvatarUrl = `https://api.dicebear.com/9.x/${currentAvatarStyle}/svg?seed=${currentUser}`;

                push(activeChatRef, {
                    name: currentUser,
                    message: text,
                    type: 'text',
                    avatarUrl: myAvatarUrl, 
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                });
                messageInput.value = "";
                remove(ref(db, 'rooms/' + currentRoomName + '/typing/' + currentUser));
            }
        }

        document.getElementById("messageInput").addEventListener('input', () => {
            set(ref(db, 'rooms/' + currentRoomName + '/typing/' + currentUser), true);
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                remove(ref(db, 'rooms/' + currentRoomName + '/typing/' + currentUser));
            }, 2000);
        });

        function setupTypingListener() {
            onValue(typingRef, (snapshot) => {
                const data = snapshot.val();
                const typingDiv = document.getElementById("typing-bar");
                if (data) {
                    const names = Object.keys(data).filter(name => name !== currentUser);
                    if (names.length > 0) {
                        typingDiv.innerText = names.join(", ") + " is typing...";
                        typingDiv.style.opacity = "1";
                    } else { typingDiv.style.opacity = "0"; }
                } else { typingDiv.style.opacity = "0"; }
            });
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const myAvatarUrl = `https://api.dicebear.com/9.x/${currentAvatarStyle}/svg?seed=${currentUser}`;
                    push(activeChatRef, {
                        name: currentUser,
                        message: e.target.result,
                        type: 'image',
                        avatarUrl: myAvatarUrl,
                        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                    });
                };
                reader.readAsDataURL(file);
                e.target.value = ''; 
            }
        });

        window.toggleTheme = function() {
            const body = document.body;
            const btn = document.getElementById("themeBtn");
            if (body.getAttribute("data-theme") === "dark") {
                body.removeAttribute("data-theme"); btn.innerText = "üåô";
            } else { body.setAttribute("data-theme", "dark"); btn.innerText = "‚òÄÔ∏è"; }
        }

        window.deleteMessage = function(messageId) {
            if(confirm("Delete this message?")) {
                const password = prompt("Enter Password:");
                if(password === ROOM_PASSWORD) {
                    remove(ref(db, 'rooms/' + currentRoomName + '/messages/' + messageId));
                } else { alert("Wrong password"); }
            }
        }

        window.clearChat = function() {
            const password = prompt("ADMIN: Clear ALL messages in this room?");
            if(password === ROOM_PASSWORD) { set(activeChatRef, null); } 
            else if (password !== null) { alert("Wrong Password"); }
        }

        function formatMessage(text) {
            text = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
            text = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            text = text.replace(/`(.*?)`/g, '<code>$1</code>');
            return text;
        }

        // --- EMOJI PICKER LOGIC ---
        const emojiList = ["üòÄ","üòÅ","üòÇ","ü§£","üòâ","üòä","üòç","ü§©","üòé","ü§î","ü§®","üòê","üôÑ","üò¥","ü§¢","ü§Æ","ü§ß","üò∑","ü§Ø","ü•≥","üî•","‚ú®","‚ù§Ô∏è","üëç","üëé","üëã","üôè","üí™","üëÄ","üéâ"];
        const picker = document.getElementById("emojiPicker");
        emojiList.forEach(emoji => {
            const span = document.createElement("span");
            span.className = "emoji-item";
            span.innerText = emoji;
            span.onclick = () => {
                const input = document.getElementById("messageInput");
                input.value += emoji;
                input.focus();
                const event = new Event('input');
                input.dispatchEvent(event);
            };
            picker.appendChild(span);
        });
        window.toggleEmojiPicker = function() {
            picker.style.display = (picker.style.display === "grid") ? "none" : "grid";
        }
        document.addEventListener('click', function(event) {
            const isClickInside = picker.contains(event.target) || document.getElementById('emojiBtn').contains(event.target);
            if (!isClickInside) picker.style.display = 'none';
        });

        document.getElementById("messageInput").addEventListener("keypress", (e) => {
            if(e.key === "Enter") sendMessage();
        });
    </script>
</body>
</html>
